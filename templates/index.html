<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASISå¢å¼ºå‹æ™ºèƒ½Agent</title>
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/collapsible.css">
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">ğŸ¤–</span>
                <h1 class="text-xl font-bold">BASISå¢å¼ºå‹æ™ºèƒ½Agent</h1>
            </div>
            <div class="flex items-center space-x-4">
                <!-- <button id="statusBtn" class="px-3 py-1 rounded hover:bg-white hover:bg-opacity-20 transition-colors">
                    <span>ğŸ“Š</span> çŠ¶æ€
                </button> -->
                <button id="memoryBtn" class="px-3 py-1 rounded hover:bg-white hover:bg-opacity-20 transition-colors">
                    <span>ğŸ§ </span> å¯¹è¯è®°å¿†
                </button>
                <button id="historyBtn" class="px-3 py-1 rounded hover:bg-white hover:bg-opacity-20 transition-colors">
                    <span>ğŸ“‹</span> å·¥å…·æ‰§è¡Œå†å²
                </button>
                <button id="clearBtn" class="px-3 py-1 rounded hover:bg-white hover:bg-opacity-20 transition-colors">
                    <span>ğŸ—‘ï¸</span> æ¸…é™¤
                </button>
                <!-- ç”¨æˆ·åŠŸèƒ½ä¸‹æ‹‰èœå• -->
                <div class="relative" id="userDropdown">
                    <button id="userMenuBtn" class="flex items-center px-3 py-1 rounded hover:bg-white hover:bg-opacity-20 transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-30">
                        <span>ğŸ‘¤</span>
                        <span class="ml-1">{{ username }}</span>
                        <span class="ml-1">â–¼</span>
                    </button>
                    <div id="userDropdownMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg opacity-0 invisible transition-all duration-200 transform translate-y-2 z-50">
                        <div class="py-1">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" onclick="showProfile(); return false;">ä¸ªäººèµ„æ–™</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" onclick="showChangePassword(); return false;">ä¿®æ”¹å¯†ç </a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" onclick="showSettings(); return false;">è®¾ç½®</a>
                            <div class="border-t border-gray-200 my-1"></div>
                            <a href="/logout" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">é€€å‡ºç™»å½•</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="flex-grow container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
        <!-- å·¦ä¾§å·¥å…·å’Œæ¨¡å‹é…ç½®é¢æ¿ -->
        <aside id="mainPanel" class="lg:w-1/3 bg-white rounded-lg shadow-md overflow-hidden h-fit collapsible-panel">
            <div id="mainHeader" class="p-4 bg-gray-100 border-b collapsible-header">
                <h2 class="text-lg font-semibold flex items-center">
                    <span class="mr-2 text-blue-500">ğŸ”§</span>
                    <span class="panel-title-text">é…ç½®é¢æ¿</span>
                </h2>
                <span class="collapse-icon text-gray-500">â–¼</span>
            </div>
            <div class="p-4 collapsible-content">
                <!-- å¯ç”¨å·¥å…·éƒ¨åˆ† - å¯æŠ˜å å­é¢æ¿ -->
                <div class="mb-4">
                    <div id="toolsSubHeader" class="flex items-center justify-between p-2 bg-gray-50 rounded-t-lg border border-gray-200 cursor-pointer">
                        <h3 class="text-md font-medium text-gray-700">å¯ç”¨å·¥å…·</h3>
                        <div class="flex items-center">
                            <button 
                                id="addToolBtn" 
                                class="bg-blue-600 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-700 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
                            >
                                <span class="mr-1">+</span> æ·»åŠ å·¥å…·
                            </button>
                            <span id="toolsSubCollapseIcon" class="text-gray-500">â–¼</span>
                        </div>
                    </div>
                    <div id="toolsSubContent" class="p-3 bg-white border-x border-b border-gray-200 rounded-b-lg">
                        <div id="toolsContainer" class="max-h-64 overflow-y-auto">
                            {% for tool in tools %}
                            <div class="tool-item mb-4 p-3 bg-blue-50 rounded border-l-4 border-blue-500" data-tool-id="{{ tool.id if tool.id is defined else tool.tool_id }}">
                                <div class="font-medium text-blue-700">
                                    <span class="mr-1">ğŸ“¦</span>
                                    {{ tool.tool_name }}
                                </div>
                                <div class="text-sm text-gray-600 mt-1">
                                    {{ tool.description }}
                                </div>
                                {% if tool.parameters %}
                                <div class="mt-2 text-xs text-gray-500">
                                    <strong>å‚æ•°:</strong>
                                    <ul class="list-disc list-inside">
                                        {% for param in tool.parameters %}
                                        <li>
                                            {{ param.name }} {% if param.required %}<span class="text-red-500">*</span>{% endif %}
                                            {% if param.description %}<span class="ml-1 text-gray-400">- {{ param.description }}</span>{% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                {% if tool.code_content %}
                                <div class="mt-2 text-xs text-gray-500">
                                    <strong>å·¥å…·ä»£ç :</strong>
                                    <pre class="bg-gray-100 p-2 rounded mt-1 text-xs overflow-x-auto">
                                        {{ tool.code_content }}
                                    </pre>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- æ¨¡å‹ä¿¡æ¯è¡¨ - å¯æŠ˜å å­é¢æ¿ -->
                <div class="mt-4">
                    <div id="modelsSubHeader" class="flex items-center justify-between p-2 bg-gray-50 rounded-t-lg border border-gray-200 cursor-pointer">
                        <h3 class="text-md font-medium text-gray-700">æ¨¡å‹ç®¡ç†</h3>
                        <div class="flex items-center">
                            <button 
                                id="addModelBtn" 
                                class="bg-blue-600 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-700 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
                            >
                                <span class="mr-1">+</span> æ·»åŠ æ¨¡å‹
                            </button>
                            <span id="modelsSubCollapseIcon" class="text-gray-500">â–¼</span>
                        </div>
                    </div>
                    <div id="modelsSubContent" class="p-3 bg-white border-x border-b border-gray-200 rounded-b-lg">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¨¡å‹</th>
                                        <!-- <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¨¡å‹åœ°å€</th> -->
                                        <!-- <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">API Key</th> -->
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Temperature</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Tokens</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ·»åŠ æ—¶é—´</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¯ç”¨çŠ¶æ€</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æè¿°</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% if models %}
                                        {% for model in models %}
                                            <tr>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ model.model_id }}</td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ model.model_name }}</td>
                                                <!-- <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 truncate max-w-[120px]" title="{{ model.model_url }}">{{ model.model_url }}</td> -->
                                                <!-- <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 truncate max-w-[80px]" title="{{ model.api_key }}">{{ model.api_key[:8] + '...' + model.api_key[-4:] if model.api_key else '' }}</td> -->
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">{{ model.temperature if model.temperature else '0.7' }}</td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">{{ model.max_tokens if model.max_tokens else '4096' }}</td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">{{ model.add_time }}</td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">
                                                    <label class="inline-flex items-center cursor-pointer">
                                                        <input 
                                                            type="checkbox" 
                                                            class="form-checkbox h-5 w-5 text-blue-600" 
                                                            data-model-id="{{ model.model_id }}" 
                                                            {{ 'checked' if model.is_active else '' }} 
                                                            onchange="toggleModelActive(this)"
                                                        >
                                                        <span class="ml-2">{{ 'å·²å¯ç”¨' if model.is_active else 'å·²ç¦ç”¨' }}</span>
                                                    </label>
                                                </td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{{ model.desc }}</td>
                                                <td class="px-3 py-2 whitespace-nowrap text-sm font-medium">
                                                    <button onclick="editModel('{{ model.model_id }}')" class="text-blue-600 hover:text-blue-900 mr-2">ç¼–è¾‘</button>
                                                    <button onclick="deleteModel('{{ model.model_id }}')" class="text-red-600 hover:text-red-900">åˆ é™¤</button>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="9" class="px-3 py-4 text-center text-sm text-gray-500">æš‚æ— æ¨¡å‹ä¿¡æ¯</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ä¸­é—´èŠå¤©åŒºåŸŸ -->
        <section id="chatSection" class="lg:flex-grow flex flex-col">
            <div class="bg-white rounded-lg shadow-md p-4 flex-grow flex flex-col">
                <!-- èŠå¤©å†å² -->
                <div id="chatHistory" class="flex-grow overflow-y-auto mb-4 p-2 space-y-4">
                    <div class="bot-message p-3 rounded-lg bg-gray-100 max-w-3xl">
                        <div class="flex items-start">
                            <div class="bg-blue-600 text-white rounded-full p-2 mr-3">
                                ğŸ¤–
                            </div>
                            <div>
                                <p class="text-gray-800">æ¬¢è¿ä½¿ç”¨BASISå¢å¼ºå‹æ™ºèƒ½Agentï¼æˆ‘å¯ä»¥å¸®åŠ©æ‚¨è§£å†³é—®é¢˜ã€æŸ¥è¯¢ä¿¡æ¯æˆ–æ‰§è¡Œè®¡ç®—ã€‚</p>
                                <p class="text-gray-600 text-sm mt-1">æç¤ºï¼šè¾“å…¥é—®é¢˜å¼€å§‹å¯¹è¯ï¼Œå¯ä¿®æ”¹å·¦ä¾§é…ç½®å“¦</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="border-t pt-4">
                    <form id="chatForm" class="flex gap-2">
                    <div class="relative flex-grow">
                        <select 
                            id="modelSelect" 
                            placeholder="è¯·é€‰æ‹©æ¨¡å‹(å†…éƒ¨é»˜è®¤qwen-flash)"
                            class="absolute left-0 top-0 bottom-0 w-44 px-3 py-2 rounded-l-lg border border-gray-300 bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                        <input 
                            type="text" 
                            id="userInput" 
                            placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–å‘½ä»¤..."
                            class="pl-48 pr-4 py-2 rounded-r-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow w-full"
                        >
                    </div>
                    <button 
                        type="submit" 
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
                    >
                        ğŸ“¤ å‘é€
                    </button>
                </form>
                
                <script>
                // åŠ è½½å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨
                function loadModels() {
                    fetch('/api/models')
                        .then(response => response.json())
                        .then(data => {
                            const modelSelect = document.getElementById('modelSelect');
                            modelSelect.innerHTML = '';
                            
                            let hasActiveModels = false;
                            
                            if (data.models && data.models.length > 0) {
                                data.models.forEach(model => {
                                    if (model.is_active) {
                                        const option = document.createElement('option');
                                        option.value = model.model_id;
                                        option.textContent = model.model_name;
                                        modelSelect.appendChild(option);
                                        hasActiveModels = true;
                                    }
                                });
                            }
                            
                            // å¦‚æœæ²¡æœ‰å¯ç”¨æ¨¡å‹ï¼Œæ˜¾ç¤ºé»˜è®¤æ¨¡å‹
                            if (!hasActiveModels) {
                                const option = document.createElement('option');
                                option.value = 'default';
                                option.textContent = 'qwen-flash (é»˜è®¤)';
                                modelSelect.appendChild(option);
                            }
                        })
                        .catch(error => {
                            console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
                            const modelSelect = document.getElementById('modelSelect');
                            modelSelect.innerHTML = '';
                            // é”™è¯¯æ—¶ä¹Ÿæ˜¾ç¤ºé»˜è®¤æ¨¡å‹
                            const option = document.createElement('option');
                            option.value = 'default';
                            option.textContent = 'qwen-flash (é»˜è®¤)';
                            modelSelect.appendChild(option);
                        });
                }
                
                // é¡µé¢åŠ è½½æ—¶è°ƒç”¨
                document.addEventListener('DOMContentLoaded', loadModels);
                </script>
                </div>
            </div>
        </section>
    </main>

    <!-- åº•éƒ¨çŠ¶æ€æ  -->
    <footer class="bg-gray-800 text-white py-3">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="text-sm">BASISå¢å¼ºå‹æ™ºèƒ½Agent v1.0</div>
            <div class="flex space-x-4 text-sm">
                <span id="memoryStatus">çŸ­æœŸè®°å¿†: 0</span>
                <span>â€¢</span>
                <span>å¯ç”¨å·¥å…·: {{ tools|length }}</span>
            </div>
        </div>
    </footer>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
                <p id="loadingMessage" class="text-gray-700">æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...</p>
            </div>
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script src="/static/js/collapsible.js"></script>
    
    <!-- æ¨¡å‹ç®¡ç†ç›¸å…³åŠŸèƒ½ -->
    <script src="/static/js/model-management.js"></script>
    <!-- å·¥å…·ç®¡ç†ç›¸å…³åŠŸèƒ½ -->
    <script src="/static/js/tool-management.js"></script>
</body>
</html>